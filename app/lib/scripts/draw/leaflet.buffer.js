!function(){function a(a){return L.latLng(a[1],a[0])}L.bufferVersion="0.1.2",L.Polygon.include({getCentroid:function(a){return a=a||this.getLatLngs(),a[0]instanceof Array?this.getCentroid(a.map(this.getCentroid)):a.reduce(function(a,b){return a.count++,a.latSum+=b.lat,a.lngSum+=b.lng,a.avg=L.latLng(a.latSum/a.count,a.lngSum/a.count),a},{count:0,latSum:0,lngSum:0}).avg}}),L.Circle.include({getCentroid:function(){return this.getLatLng()}}),L.drawLocal.edit.toolbar.buttons.buffer="Expand layers.",L.drawLocal.edit.toolbar.buttons.bufferDisabled="No layers to expand.",L.drawLocal.edit.handlers.buffer={tooltip:{text:"Click and drag to expand or contract a shape."}};var b=L.EditToolbar.prototype.getModeHandlers;L.EditToolbar.prototype.getModeHandlers=function(a){var c=this.options.buffer;return c&&(c.featureGroup=this.options.featureGroup,"replace_polylines"in c||(c.replace_polylines=!0),"buffer_style"in c||(c.buffer_style={fill:!0,dashArray:"1, 10"}),"separate_buffer"in c||(c.separate_buffer=!1)),b.call(this,a).concat([{enabled:c,handler:new L.EditToolbar.Buffer(a,c)}])};var c=L.EditToolbar.prototype._checkDisabled;L.EditToolbar.prototype._checkDisabled=function(){c.call(this);var a,b=this.options.featureGroup,d=0!==b.getLayers().length;this.options.buffer&&(a=this._modes[L.EditToolbar.Buffer.TYPE].button,d?L.DomUtil.removeClass(a,"leaflet-disabled"):L.DomUtil.addClass(a,"leaflet-disabled"),a.setAttribute("title",d?L.drawLocal.edit.toolbar.buttons.buffer:L.drawLocal.edit.toolbar.buttons.bufferDisabled))},L.EditToolbar.Buffer=L.Handler.extend({statics:{TYPE:"buffer"},includes:L.Mixin.Events,_draggingLayer:null,_originalLayers:{},_bufferData:{},initialize:function(a,b){if(L.Handler.prototype.initialize.call(this,a),this._selectedPathOptions=b.selectedPathOptions,this._featureGroup=b.featureGroup,this._replace_polyline=b.replace_polylines,this._separate_buffer=b.separate_buffer,this._buffer_style=b.buffer_style,!(this._featureGroup instanceof L.FeatureGroup))throw new Error("options.featureGroup must be a L.FeatureGroup");this._unbufferedLayerProps={},this.type=L.EditToolbar.Buffer.TYPE},enable:function(){!this._enabled&&this._hasAvailableLayers()&&(this.fire("enabled",{handler:this.type}),this._map.fire("draw:bufferstart",{handler:this.type}),L.Handler.prototype.enable.call(this),this._featureGroup.on("layeradd",this._enableLayerBuffer,this).on("layerremove",this._disableLayerBuffer,this))},disable:function(){this._enabled&&(this._featureGroup.off("layeradd",this._enableLayerBuffer,this).off("layerremove",this._disableLayerBuffer,this),L.Handler.prototype.disable.call(this),this._map.fire("draw:bufferstop",{handler:this.type}),this.fire("disabled",{handler:this.type}))},addHooks:function(){var a=this._map;a&&(a.getContainer().focus(),this._featureGroup.eachLayer(this._enableLayerBuffer,this),this._tooltip=new L.Tooltip(this._map),this._setTooltip(L.drawLocal.edit.handlers.buffer.tooltip.text),this._map.on("mousemove",this._onMouseMove,this))},removeHooks:function(){this._map&&(this._featureGroup.eachLayer(this._disableLayerBuffer,this),this._unbufferedLayerProps={},this._tooltip.dispose(),this._tooltip=null,this._map.off("mousemove",this._onMouseMove,this))},revertLayers:function(){this._featureGroup.eachLayer(function(a){this._revertLayer(a)},this)},save:function(){var a=new L.LayerGroup,b=new L.LayerGroup;this._featureGroup.eachLayer(function(c){var d=this._originalLayers[L.Util.stamp(c)];c.buffered&&(a.addLayer(c),c.buffered=!1),d&&(this._map.fire("draw:created",{layer:c}),this._replace_polyline&&b.addLayer(d))}.bind(this)),this._originalLayers={},this._map.fire("draw:buffered",{layers:a}),this._map.fire("draw:deleted",{layers:b})},_backupLayer:function(a){var b=L.Util.stamp(a);this._unbufferedLayerProps[b]||(a instanceof L.Polygon||a instanceof L.Rectangle?this._unbufferedLayerProps[b]={latlngs:L.LatLngUtil.cloneLatLngs(a.getLatLngs())}:a instanceof L.Circle&&(this._unbufferedLayerProps[b]={latlng:L.LatLngUtil.cloneLatLng(a.getLatLng()),radius:a.getRadius()}))},_revertLayer:function(a){var b=L.Util.stamp(a);a.buffered=!1,b in this._originalLayers?(this._featureGroup.addLayer(this._originalLayers[b]),this._featureGroup.removeLayer(a),delete this._originalLayers[b]):this._unbufferedLayerProps.hasOwnProperty(b)?a instanceof L.Polygon||a instanceof L.Rectangle?a.setLatLngs(this._unbufferedLayerProps[b].latlngs):a instanceof L.Circle&&(a.setLatLng(this._unbufferedLayerProps[b].latlng),a.setRadius(this._unbufferedLayerProps[b].radius)):a instanceof L.Polygon&&this._map.removeLayer(a)},_enableLayerBuffer:function(a){var b=a.layer||a.target||a;b instanceof L.Marker||(this._backupLayer(b),b.buffered=!0,b.on("mousedown",this._onLayerDragStart,this),this._map.on("mouseup",this._onLayerDragEnd,this))},_disableLayerBuffer:function(a){var b=a.layer||a.target||a;b.buffered=!1,this._bufferData={},b.off("mousedown",this._onLayerDragStart,this),this._map.off("mouseup",this._onLayerDragEnd,this)},_onLayerDragStart:function(b){var c=b.layer||b.target||b,d=c instanceof L.Polygon,e=L.Util.stamp(c);if(c instanceof L.Polyline&&!d||this._separate_buffer&&!(e in this._originalLayers)){var f=this._buffer(c.toGeoJSON(),1e-5);c=new L.Polygon(f.coordinates[0].map(a));var g=L.Util.stamp(c);this._originalLayers[g]=c,c.setStyle(this._buffer_style),this._replace_polyline&&!d&&this._featureGroup.removeLayer(temp),this._featureGroup.addLayer(c)}this._map.on("mousemove",this._onLayerDrag,this),this._draggingLayer=c,this._draggingLayerId=L.Util.stamp(c),this._draggingLayerId in this._bufferData||(this._bufferData[this._draggingLayerId]=c instanceof L.Circle?{radius:c.getRadius(),temp_radius:0,orig_geoJSON:c.toGeoJSON()}:{size:0,temp_size:0,radius:0,temp_radius:0,orig_geoJSON:c.toGeoJSON()});var h=c.getCentroid();this._bufferData[this._draggingLayerId].centroid=h,this._bufferData[this._draggingLayerId].orig_distanceToCenter=b.latlng.distanceTo(this._bufferData[this._draggingLayerId].centroid),this._setTooltip(this._bufferData[this._draggingLayerId].radius)},_onLayerDrag:function(b){b.originalEvent.stopPropagation();var c=this._bufferData[this._draggingLayerId],d=c.centroid.distanceTo(b.latlng)-c.orig_distanceToCenter;if(c.temp_radius=c.radius+d,this._setTooltip(c.temp_radius),this._draggingLayer instanceof L.Circle)this._draggingLayer.setRadius(c.temp_radius);else{d/=111120,c.temp_size=c.size+d;var e=this._buffer(c.orig_geoJSON,c.temp_size);"MultiPolygon"!==e.type&&this._draggingLayer.setLatLngs(e.coordinates[0].map(a))}},_onLayerDragEnd:function(){var a=this._bufferData[this._draggingLayerId];a&&(a.size=a.temp_size,a.radius=a.temp_radius),this._map.off("mousemove",this._onLayerDrag,this),this._draggingLayer=null,this._setTooltip(L.drawLocal.edit.handlers.buffer.tooltip.text)},_onMarkerDragEnd:function(a){var b=a.target;b.edited=!0},_onMouseMove:function(a){this._tooltip.updatePosition(a.latlng)},_hasAvailableLayers:function(){return 0!==this._featureGroup.getLayers().length},_setTooltip:function(a){var b;if("string"==typeof a)b=a;else{var c=a,d=c/1e3,e=3.28084*c,f=e/5280,g=d>=1?"km":"m",h=(d>=1?d:c).toFixed(2),i=f>=.1?"mi":"ft",j=(f>=.1?f:e).toFixed(2);b="Buffer radius: ",b+=h+g+" ",b+=j+i+" "}this._tooltip.updateContent({text:b})},_buffer:function(a,b){var c=new jsts.io.GeoJSONReader,d=new jsts.io.GeoJSONWriter,e=c.read(a).geometry.buffer(b);return d.write(e)}})}(window,document);